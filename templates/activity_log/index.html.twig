{% extends 'base.html.twig' %}

{% block title %}Activity Logs — CompileX{% endblock %}

{% block stylesheets %}
<style>
  html{scroll-behavior:smooth}
  .glass{background:rgba(30,41,59,.92);backdrop-filter:blur(10px)}
  .dark .glass{background:rgba(31,41,55,.88)}
  .sidebar{width:18rem}
  .sidebar-collapsed .sidebar{width:5.25rem}
  .sidebar-collapsed .nav-text{display:none}
  .sidebar-collapsed .nav-group-title{display:none}
  .sidebar-collapsed .brand-sub{display:none}
  .content{margin-left:18rem}
  .sidebar-collapsed .content{margin-left:5.25rem}
  @media (max-width: 767px){.content{margin-left:0}}
</style>
{% endblock %}

{% block body %}
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={darkMode:'class'};</script>

{% set currentRoute = app.request.attributes.get('_route') %}
{% set isAdmin = is_granted('ROLE_ADMIN') %}
{% set isInstructor = is_granted('ROLE_INSTRUCTOR') %}
{% set isStudent = is_granted('ROLE_USER') %}

<div id="root" class="min-h-screen bg-slate-50 dark:bg-gray-900 text-slate-900 dark:text-gray-100">

  <header class="fixed top-0 left-0 right-0 z-40 glass border-b border-white/10">
    <div class="px-4 md:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="burger-mobile" class="md:hidden w-10 h-10 rounded-xl bg-white/10 hover:bg-white/20" aria-label="Open menu">&#9776;</button>

        <button id="burger-desktop" class="hidden md:inline-flex w-10 h-10 rounded-xl bg-white/10 hover:bg-white/20 items-center justify-center" aria-label="Collapse sidebar">≡</button>

        <div class="leading-tight">
          <div class="text-lg font-semibold text-blue-400">
            CompileX
            <span class="text-white/60 text-sm font-medium">
              {% if isAdmin %}Admin{% elseif isInstructor %}Instructor{% else %}Student{% endif %}
            </span>
          </div>
          <div class="text-xs text-white/70 brand-sub">Activity Logs</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="mode-toggle" class="px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 text-sm">Mode</button>
        <a href="{{ path('app_logout') }}" class="px-3 py-1.5 rounded-full bg-red-500/20 text-red-200 hover:bg-red-500/30 text-sm">Logout</a>
      </div>
    </div>
  </header>

  <div class="h-16"></div>

  <div id="backdrop" class="hidden fixed inset-0 z-40 bg-black/40 md:hidden"></div>

  <aside id="sidebar"
         class="sidebar fixed top-16 left-0 z-50 h-[calc(100vh-64px)] bg-slate-900 dark:bg-gray-900 border-r border-white/10 overflow-y-auto transform -translate-x-full md:translate-x-0 transition-transform duration-300">
    <nav class="px-4 py-6 space-y-6 text-sm">

      <div class="px-1">
        <div class="flex items-center gap-2">
          <div class="w-9 h-9 rounded-xl bg-white/10 border border-white/10 flex items-center justify-center font-bold text-blue-200">CX</div>
          <div class="leading-tight">
            <div class="text-sm font-semibold tracking-tight text-blue-200">CompileX</div>
            <div class="text-xs text-white/60 brand-sub">
              {% if isAdmin %}Admin Panel{% elseif isInstructor %}Instructor Panel{% else %}Student Panel{% endif %}
            </div>
          </div>
        </div>
      </div>

      <div>
        <p class="nav-group-title text-xs uppercase text-white/50 mb-2">Overview</p>

        <a href="{{ path('home') }}"
           class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                  {% if currentRoute == 'home' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
          <span class="w-2.5 h-2.5 rounded-full bg-white/60"></span>
          <span class="nav-text">Home</span>
        </a>

        {% if isAdmin %}
          <a href="{{ path('app_admin') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute == 'app_admin' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-blue-300/80"></span>
            <span class="nav-text">Admin Dashboard</span>
          </a>
        {% endif %}

        {% if isInstructor %}
          <a href="{{ path('app_instructor_dashboard') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute == 'app_instructor_dashboard' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-emerald-300/80"></span>
            <span class="nav-text">Instructor Dashboard</span>
          </a>
        {% endif %}

        {% if isStudent %}
          <a href="{{ path('app_student_dashboard') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute == 'app_student_dashboard' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-sky-300/80"></span>
            <span class="nav-text">Student Dashboard</span>
          </a>
        {% endif %}
      </div>

      {% if isAdmin %}
        <div>
          <p class="nav-group-title text-xs uppercase text-white/50 mb-2">Management</p>

          <a href="{{ path('app_user_index') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute starts with 'app_user_' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-indigo-300/80"></span>
            <span class="nav-text">Users</span>
          </a>

          <a href="{{ path('app_student_profile_index') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute starts with 'app_student_profile_' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-sky-300/80"></span>
            <span class="nav-text">Students</span>
          </a>

          <a href="{{ path('app_instructor_application_admin_index') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute starts with 'app_instructor_application_admin_' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-rose-300/80"></span>
            <span class="nav-text">Instructor Applications</span>
          </a>

          <a href="{{ path('app_instructor_assignment_index') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute starts with 'app_instructor_assignment_' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-orange-300/80"></span>
            <span class="nav-text">Instructor Assignments</span>
          </a>
        </div>

        <div>
          <p class="nav-group-title text-xs uppercase text-white/50 mb-2">Learning</p>

          <a href="{{ path('app_course_index') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute starts with 'app_course_' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-emerald-300/80"></span>
            <span class="nav-text">Courses</span>
          </a>

          <a href="{{ path('app_subject_index') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute starts with 'app_subject_' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-amber-300/80"></span>
            <span class="nav-text">Subjects</span>
          </a>

          <a href="{{ path('app_module_index') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute starts with 'app_module_' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-purple-300/80"></span>
            <span class="nav-text">Modules</span>
          </a>

          <a href="{{ path('app_enrollment_index') }}"
             class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                    {% if currentRoute starts with 'app_enrollment_' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
            <span class="w-2.5 h-2.5 rounded-full bg-fuchsia-300/80"></span>
            <span class="nav-text">Enrollments</span>
          </a>
        </div>
      {% endif %}

      <div>
        <p class="nav-group-title text-xs uppercase text-white/50 mb-2">System</p>

        <a href="{{ path('app_activity_log_index') }}"
           class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium
                  {% if currentRoute starts with 'app_activity_log_' %} bg-white/10 border border-white/10 {% else %} hover:bg-white/10 {% endif %}">
          <span class="w-2.5 h-2.5 rounded-full bg-pink-300/80"></span>
          <span class="nav-text">Activity Logs</span>
        </a>

        <button id="mode-toggle-side"
                class="w-full flex items-center gap-3 px-3 py-2 rounded-xl font-medium hover:bg-white/10">
          <span class="w-2.5 h-2.5 rounded-full bg-white/60"></span>
          <span class="nav-text">Toggle Mode</span>
        </button>

        <a href="{{ path('home') }}"
           class="flex items-center gap-3 px-3 py-2 rounded-xl font-medium hover:bg-white/10">
          <span class="w-2.5 h-2.5 rounded-full bg-white/60"></span>
          <span class="nav-text">Back to Home</span>
        </a>
      </div>

    </nav>
  </aside>

  <main class="content px-4 md:px-8 py-8">
    <div class="max-w-7xl mx-auto space-y-6">

      <div class="space-y-2">
        <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">Activity Logs</h1>
        <p class="text-sm md:text-base text-slate-600 dark:text-gray-400">
          Track system actions across courses, subjects, modules, enrollments, and assignments.
        </p>

        <div class="flex flex-wrap gap-2 text-xs md:text-sm">
          <a href="#filters" class="px-3 py-1.5 rounded-full border border-slate-300 dark:border-gray-700 hover:bg-white dark:hover:bg-gray-800 bg-white/60 dark:bg-gray-800/40">Filters</a>
          <a href="#table" class="px-3 py-1.5 rounded-full border border-slate-300 dark:border-gray-700 hover:bg-white dark:hover:bg-gray-800 bg-white/60 dark:bg-gray-800/40">Logs Table</a>
        </div>
      </div>

      {% for label, messages in app.flashes %}
        {% for message in messages %}
          <div class="rounded-2xl border px-4 py-3 text-sm
                      {% if label == 'success' %} bg-green-50 border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-700 dark:text-green-200
                      {% elseif label == 'error' %} bg-red-50 border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-700 dark:text-red-200
                      {% else %} bg-slate-50 border-slate-200 text-slate-800 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200
                      {% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      {% endfor %}

      <form id="filters" method="get" action="{{ path('app_activity_log_index') }}"
            class="bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-2xl shadow-sm p-4 md:p-5 scroll-mt-24">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">

          <div class="md:col-span-6">
            <label class="block text-xs font-semibold text-slate-600 dark:text-gray-300 mb-1">Search</label>
            <input type="text"
                   name="q"
                   value="{{ app.request.query.get('q') }}"
                   class="w-full rounded-lg border-slate-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-sm focus:ring-indigo-500 focus:border-indigo-500"
                   placeholder="Search by user email, action, context, or description">
          </div>

          <div class="md:col-span-4">
            <label class="block text-xs font-semibold text-slate-600 dark:text-gray-300 mb-1">Action</label>
            {% set currentAction = app.request.query.get('action') %}
            <select name="action"
                    class="w-full rounded-lg border-slate-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-sm focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">All actions</option>
              {% for a in availableActions %}
                <option value="{{ a }}" {{ currentAction == a ? 'selected' : '' }}>{{ a }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="md:col-span-2 flex gap-2">
            <button class="w-full rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold px-4 py-2">Filter</button>
            <a href="{{ path('app_activity_log_index') }}"
               class="w-full text-center rounded-lg border border-slate-300 dark:border-gray-600 hover:bg-slate-50 dark:hover:bg-gray-900 text-sm font-semibold px-4 py-2">Reset</a>
          </div>
        </div>
      </form>

      <div id="table" class="bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-2xl shadow-sm overflow-hidden scroll-mt-24">
        <div class="px-4 md:px-5 py-3 border-b border-slate-200 dark:border-gray-700 flex items-center justify-between">
          <h2 class="text-sm font-semibold text-slate-800 dark:text-gray-100">Logs ({{ logs|length }})</h2>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 dark:bg-gray-900">
              <tr class="text-left text-xs uppercase tracking-wide text-slate-500 dark:text-gray-400">
                <th class="px-4 md:px-5 py-2">Date</th>
                <th class="px-4 md:px-5 py-2">User</th>
                <th class="px-4 md:px-5 py-2">Action</th>
                <th class="px-4 md:px-5 py-2">Context</th>
                <th class="px-4 md:px-5 py-2">Description</th>
                <th class="px-4 md:px-5 py-2 text-right">View</th>
              </tr>
            </thead>
            <tbody>
              {% for l in logs %}
                {% set u = l.user is defined ? l.user : null %}
                <tr class="border-t border-slate-100 dark:border-gray-700 hover:bg-slate-50 dark:hover:bg-gray-900">
                  <td class="px-4 md:px-5 py-2 text-xs whitespace-nowrap">
                    {% if l.createdAt is defined and l.createdAt %}
                      {{ l.createdAt|date('Y-m-d H:i') }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td class="px-4 md:px-5 py-2 text-xs">
                    {{ u and u.email is defined ? u.email : '—' }}
                  </td>
                  <td class="px-4 md:px-5 py-2 text-xs font-mono">
                    {{ l.action is defined and l.action ? l.action : '—' }}
                  </td>
                  <td class="px-4 md:px-5 py-2 text-xs">
                    {{ l.context is defined and l.context ? l.context : '—' }}
                  </td>
                  <td class="px-4 md:px-5 py-2 text-xs">
                    {% set d = l.description is defined ? l.description : '' %}
                    {{ d ? (d|length > 70 ? d|slice(0,70) ~ '…' : d) : '—' }}
                  </td>
                  <td class="px-4 md:px-5 py-2 text-right">
                    <a href="{{ path('app_activity_log_show', {id: l.id}) }}"
                       class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Details →</a>
                  </td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-sm text-slate-500 dark:text-gray-400">
                    No activity logs found.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <p class="text-xs text-slate-500 dark:text-gray-400">
        Tip: Search supports email, action keyword, context, and description text.
      </p>
    </div>
  </main>

</div>

<script>
const DARK_KEY='compilex-dark-mode'
const SIDEBAR_KEY='compilex-admin-sidebar-collapsed'

const sidebar=document.getElementById('sidebar')
const backdrop=document.getElementById('backdrop')
const modeToggle=document.getElementById('mode-toggle')
const modeToggleSide=document.getElementById('mode-toggle-side')
const burgerMobile=document.getElementById('burger-mobile')
const burgerDesktop=document.getElementById('burger-desktop')
const root=document.getElementById('root')

function setTheme(isDark){
  document.documentElement.classList.toggle('dark',!!isDark)
  localStorage.setItem(DARK_KEY,(!!isDark).toString())
}

function loadTheme(){
  setTheme(localStorage.getItem(DARK_KEY)==='true')
}

function openSidebar(){
  sidebar.classList.remove('-translate-x-full')
  if(backdrop) backdrop.classList.remove('hidden')
  document.body.classList.add('overflow-hidden')
}

function closeSidebar(){
  sidebar.classList.add('-translate-x-full')
  if(backdrop) backdrop.classList.add('hidden')
  document.body.classList.remove('overflow-hidden')
}

function toggleSidebar(){
  const isMobile=window.innerWidth<768
  if(isMobile){
    if(sidebar.classList.contains('-translate-x-full')) openSidebar(); else closeSidebar()
    return
  }
  root.classList.toggle('sidebar-collapsed')
  localStorage.setItem(SIDEBAR_KEY,root.classList.contains('sidebar-collapsed')?'true':'false')
}

function loadSidebarState(){
  const saved=localStorage.getItem(SIDEBAR_KEY)==='true'
  root.classList.toggle('sidebar-collapsed',saved)
}

if(modeToggle){
  modeToggle.addEventListener('click',()=>{
    const isDark=document.documentElement.classList.contains('dark')
    setTheme(!isDark)
  })
}

if(modeToggleSide){
  modeToggleSide.addEventListener('click',()=>{
    const isDark=document.documentElement.classList.contains('dark')
    setTheme(!isDark)
  })
}

if(burgerMobile) burgerMobile.addEventListener('click',toggleSidebar)
if(burgerDesktop) burgerDesktop.addEventListener('click',toggleSidebar)
if(backdrop) backdrop.addEventListener('click',closeSidebar)

document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){
    if(window.innerWidth<768) closeSidebar()
  }
})

window.addEventListener('resize',()=>{
  if(window.innerWidth>=768){
    if(backdrop) backdrop.classList.add('hidden')
    document.body.classList.remove('overflow-hidden')
    sidebar.classList.remove('-translate-x-full')
  }else{
    sidebar.classList.add('-translate-x-full')
  }
})

loadTheme()
loadSidebarState()
if(window.innerWidth<768) closeSidebar()
</script>
{% endblock %}
